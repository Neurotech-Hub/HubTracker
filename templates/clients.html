{% extends "base.html" %}

{% block title %}Clients - Hub Tracker{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">Clients</h2>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                    <i class="bi bi-plus-circle me-2"></i>Add Client
                </button>
            </div>
        </div>
    </div>

    <!-- Clients List -->
    <div class="row">
        <div class="col-12">
            {% if clients %}
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0">Client</th>
                                        <th class="border-0">Membership</th>
                                        <th class="border-0">Projects</th>
                                        <th class="border-0 text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in clients %}
                                    {% with show_edit=true, show_add_project=true, show_delete=true %}
                                        {% include 'partials/client_row.html' %}
                                    {% endwith %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-people fs-1 mb-3 d-block"></i>
                    <div class="fw-medium">No clients found</div>
                    <div class="small mb-3">Create your first client to get started</div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Client
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_client') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addClientName" class="form-label">Client Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addClientName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="addClientMembership" class="form-label">Membership</label>
                        <select class="form-select" id="addClientMembership" name="membership_id">
                            <option value="">No membership assigned</option>
                            {% for membership in memberships %}
                                <option value="{{ membership.id }}">
                                    {{ membership.title }}
                                    {% if membership.start_date %} - {{ membership.start_date.strftime('%b %d, %Y') }}{% endif %}
                                    {% if membership.is_annual %} (Annual){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                        {% if not memberships %}
                            <div class="form-text text-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                No memberships available. <a href="{{ url_for('memberships') }}">Create a membership first</a>.
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="addClientNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="addClientNotes" name="notes" rows="3" placeholder="Optional client notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Client</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Client Modal -->
<div class="modal fade" id="editClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editClientForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editClientName" class="form-label">Client Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editClientName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editClientMembership" class="form-label">Membership</label>
                        <select class="form-select" id="editClientMembership" name="membership_id">
                            <option value="">No membership assigned</option>
                            {% for membership in memberships %}
                                <option value="{{ membership.id }}">
                                    {{ membership.title }}
                                    {% if membership.start_date %} - {{ membership.start_date.strftime('%b %d, %Y') }}{% endif %}
                                    {% if membership.is_annual %} (Annual){% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editClientNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editClientNotes" name="notes" rows="3" placeholder="Optional client notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Client</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Project Modal (pre-populated for client) -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_project') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Project for <span id="projectClientName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addProjectNameForClient" class="form-label">Project Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addProjectNameForClient" name="name" required>
                    </div>
                    <input type="hidden" id="addProjectClientId" name="client_id">
                    <div class="mb-3">
                        <label for="addProjectLeadForClient" class="form-label">Project Lead</label>
                        <select class="form-select" id="addProjectLeadForClient" name="project_lead_id">
                            <option value="">Select a project lead...</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addProjectNotesForClient" class="form-label">Notes</label>
                        <textarea class="form-control" id="addProjectNotesForClient" name="notes" rows="3" placeholder="Optional project notes..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addProjectDefaultForClient" name="is_default">
                            <label class="form-check-label" for="addProjectDefaultForClient">
                                Set as default project
                            </label>
                            <div class="form-text">Tasks without a specified project will be assigned here</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteItemName"></span>"?</p>
                <p class="text-muted mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function editClient(id, name, membershipId, notes) {
    document.getElementById('editClientForm').action = `/edit_client/${id}`;
    document.getElementById('editClientName').value = name;
    document.getElementById('editClientMembership').value = membershipId || '';
    document.getElementById('editClientNotes').value = notes;
}

function addProjectForClient(clientId, clientName) {
    document.getElementById('projectClientName').textContent = clientName;
    document.getElementById('addProjectClientId').value = clientId;
    document.getElementById('addProjectNameForClient').value = '';
    document.getElementById('addProjectLeadForClient').value = '';
    document.getElementById('addProjectNotesForClient').value = '';
    document.getElementById('addProjectDefaultForClient').checked = false;
}

function confirmDelete(itemName, deleteUrl) {
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteForm').action = deleteUrl;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %} 