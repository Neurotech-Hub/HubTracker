<!-- Smart Task Form with Alpine.js -->
<div class="quick-task-form" x-data="taskForm()" x-init="init()" @set-preset-project="handlePresetProject($event)" @set-preset-user="handlePresetUser($event)"
    <form method="POST" action="{{ url_for('add_task') }}" @submit="onSubmit()">
        <!-- Main Input Area -->
        <div class="position-relative">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1 me-3">
                    <input 
                        type="text" 
                        name="description" 
                        class="form-control task-input" 
                        placeholder="What needs to be done? Use #project and @user" 
                        required
                        autocomplete="off"
                        autofocus
                        x-model="rawInput"
                        @input="parseInput()"
                        @keydown="handleKeydown($event)"
                        x-ref="taskInput"
                    >
                </div>
                <button type="submit" class="btn btn-primary task-submit-btn">
                    <i class="bi bi-plus-circle"></i>
                    <span class="d-none d-sm-inline ms-1">Add Task</span>
                </button>
            </div>

            <!-- Autocomplete Dropdown -->
            <div x-show="showAutocomplete" 
                 class="autocomplete-dropdown position-absolute w-100 mt-1"
                 x-transition:enter="transition ease-out duration-100"
                 x-transition:enter-start="opacity-0 scale-95"
                 x-transition:enter-end="opacity-100 scale-100"
                 x-transition:leave="transition ease-in duration-75"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95">
                <div class="bg-white border rounded-3 shadow-lg">
                    <template x-for="(item, index) in filteredItems" :key="item.id">
                        <div class="autocomplete-item px-3 py-2 cursor-pointer border-bottom"
                             :class="{ 'bg-primary text-white': index === selectedIndex }"
                             @click="selectItem(item)"
                             @mouseenter="selectedIndex = index">
                            <div x-text="item.display || item.name"></div>
                            <small class="opacity-75" x-show="item.client_name" x-text="'Client: ' + item.client_name"></small>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Assignment Display -->
        <div class="task-assignments mt-2">
            <small class="text-muted d-flex align-items-center flex-wrap">
                <span x-show="selectedProject" class="assignment-tag me-3 mb-1">
                    <i class="bi bi-folder me-1"></i>
                    <span x-text="selectedProject.display_name"></span>
                </span>
                <span x-show="selectedUser.id" class="assignment-tag me-3 mb-1">
                    <i class="bi bi-person me-1"></i>
                    <span x-text="selectedUser.name"></span>
                </span>
                <span x-show="!selectedProject.id && !selectedUser.id" class="text-muted fst-italic">
                    Type # for projects, @ for users
                </span>
            </small>
        </div>

        <!-- Hidden form fields -->
        <input type="hidden" name="project_id" x-model="selectedProject.id">
        <input type="hidden" name="assigned_to" x-model="selectedUser.id">
        <input type="hidden" name="original_input" x-ref="originalInput">
    </form>
</div> 