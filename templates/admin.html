{% extends "base.html" %}

{% block title %}Admin - Hub Tracker{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0">Admin Dashboard</h2>
        </div>
    </div>

    <!-- Admin Sections -->
    <div class="row">
        <!-- User Management Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">User Management</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-plus-circle me-1"></i>Add User
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Equipment</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.full_name }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="badge {% if user.role == 'admin' %}bg-danger{% elif user.role == 'finance' %}bg-success{% else %}bg-info{% endif %}">
                                            {{ user.role }}
                                        </span>
                                    </td>
                                    <td>
                                        {% for equipment in user.equipment %}
                                        <span class="badge bg-secondary me-1">{{ equipment.name }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editUserModal{{ user.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% if user.id != session.user_id %}
                                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteUserModal{{ user.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Management Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Equipment Management</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEquipmentModal">
                        <i class="bi bi-plus-circle me-1"></i>Add Equipment
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Manual</th>
                                    <th>Scheduling</th>
                                    <th>Assigned Users</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for equipment in equipment_list %}
                                <tr>
                                    <td>{{ equipment.name }}</td>
                                    <td>{{ equipment.description or '' }}</td>
                                    <td>
                                        {% if equipment.manual %}
                                        <a href="{{ equipment.manual }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-file-earmark-text"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if equipment.is_schedulable %}
                                        <span class="badge bg-success">Enabled</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Disabled</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for user in equipment.users %}
                                        {{ user.full_name }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editEquipmentModal{{ equipment.id }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteEquipmentModal{{ equipment.id }}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Import Section -->
        {% if project_count == 0 %}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Data Import</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('import_labs_projects') }}" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="importFile" class="form-label">Import Labs/Projects</label>
                            <input type="file" class="form-control" id="importFile" name="import_file" accept=".json,.txt">
                            <div class="form-text">Upload a JSON or TXT file containing labs and projects data.</div>
                        </div>
                        <button type="submit" class="btn btn-primary">Import Data</button>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Global Scheduling Settings Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Global Scheduling Settings</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('update_scheduling_settings') }}" method="POST">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="maxBookingDuration" class="form-label">Max Booking Duration (hours)</label>
                                    <input type="number" class="form-control" id="maxBookingDuration" name="max_booking_duration_hours" 
                                           value="{{ scheduling_settings.max_booking_duration_hours }}" step="0.5" min="0.5" max="24">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="minBookingNotice" class="form-label">Min Booking Notice (hours)</label>
                                    <input type="number" class="form-control" id="minBookingNotice" name="min_booking_notice_hours" 
                                           value="{{ scheduling_settings.min_booking_notice_hours }}" step="0.5" min="0" max="168">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="bookingAdvanceLimit" class="form-label">Booking Advance Limit (days)</label>
                                    <input type="number" class="form-control" id="bookingAdvanceLimit" name="booking_advance_limit_days" 
                                           value="{{ scheduling_settings.booking_advance_limit_days }}" min="1" max="365">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Settings</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Global Operating Hours Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Global Operating Hours</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#operatingHoursModal">
                        <i class="bi bi-clock me-1"></i>Set Operating Hours
                    </button>
                </div>
                <div class="card-body">
                    {% if operating_hours %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                                {% for day_num in range(7) %}
                                {% set day_hours = operating_hours|selectattr('day_of_week', 'equalto', day_num)|first %}
                                <tr>
                                    <td>{{ days[day_num] }}</td>
                                    <td>{{ day_hours.start_time.strftime('%H:%M') if day_hours else 'Closed' }}</td>
                                    <td>{{ day_hours.end_time.strftime('%H:%M') if day_hours else '' }}</td>
                                    <td>
                                        {% if day_hours %}
                                        <span class="badge bg-success">Open</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Closed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No operating hours set. Click "Set Operating Hours" to configure.</p>
                    {% endif %}
                </div>
            </div>
        </div>



        <!-- Global Blocked Dates Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Global Blocked Dates</h5>
                    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#addBlockedDateModal">
                        <i class="bi bi-calendar-x me-1"></i>Add Blocked Date
                    </button>
                </div>
                <div class="card-body">
                    {% if blocked_dates %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Reason</th>
                                    <th>Recurring</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for blocked_date in blocked_dates %}
                                <tr>
                                    <td>{{ blocked_date.blocked_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{% if blocked_date.reason %}{{ blocked_date.reason }}{% else %}<span class="text-muted">None</span>{% endif %}</td>
                                    <td>
                                        {% if blocked_date.is_annual_recurring %}
                                        <span class="badge bg-info">Annual</span>
                                        {% else %}
                                        <span class="badge bg-secondary">One-time</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form action="{{ url_for('delete_blocked_date', blocked_date_id=blocked_date.id) }}" method="POST" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to remove this blocked date?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No blocked dates found.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Upcoming Appointments Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Upcoming Appointments (Next 30 Days)</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAppointmentModal">
                        <i class="bi bi-plus-circle me-1"></i>Create Appointment
                    </button>
                </div>
                <div class="card-body">
                    {% if upcoming_appointments %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Equipment</th>
                                    <th>User</th>
                                    <th>Date & Time</th>
                                    <th>Duration</th>
                                    <th>Purpose</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for appointment in upcoming_appointments %}
                                <tr>
                                    <td>{{ appointment.equipment.name }}</td>
                                    <td>{{ appointment.user.full_name }}</td>
                                    <td>{{ appointment.start_time.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ "%.1f"|format(appointment.duration_hours) }}h</td>
                                    <td>{{ appointment.purpose or '' }}</td>
                                    <td>
                                        <span class="badge {% if appointment.status == 'approved' %}bg-success{% elif appointment.status == 'pending' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ appointment.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if appointment.status == 'pending' %}
                                            <button type="button" class="btn btn-sm btn-success" onclick="updateAppointmentStatus({{ appointment.id }}, 'approved')" title="Approve">
                                                <i class="bi bi-check-circle"></i>
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="updateAppointmentStatus({{ appointment.id }}, 'cancelled')" title="Cancel">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No upcoming appointments found.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_user') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="firstName" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" name="first_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastName" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" name="last_name">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">Role</label>
                        <select class="form-select" id="role" name="role" required onchange="togglePasswordRequired(this, 'password')">
                            <option value="trainee">Trainee</option>
                            <option value="finance">Finance</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password">
                        <div class="form-text password-help">Password is only required for admin users.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Equipment Access</label>
                        <div class="equipment-checkboxes">
                            {% for equipment in equipment_list %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="equipment[]" value="{{ equipment.id }}" id="equipment{{ equipment.id }}">
                                <label class="form-check-label" for="equipment{{ equipment.id }}">
                                    {{ equipment.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modals -->
{% for user in users %}
<div class="modal fade" id="editUserModal{{ user.id }}" tabindex="-1" aria-labelledby="editUserModalLabel{{ user.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('edit_user', user_id=user.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel{{ user.id }}">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="firstName{{ user.id }}" class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName{{ user.id }}" name="first_name" value="{{ user.first_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastName{{ user.id }}" class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName{{ user.id }}" name="last_name" value="{{ user.last_name or '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="email{{ user.id }}" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email{{ user.id }}" name="email" value="{{ user.email }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="role{{ user.id }}" class="form-label">Role</label>
                        <select class="form-select" id="role{{ user.id }}" name="role" required onchange="togglePasswordRequired(this, 'password{{ user.id }}', '{{ user.role }}')">
                            <option value="trainee" {% if user.role == 'trainee' %}selected{% endif %}>Trainee</option>
                            <option value="finance" {% if user.role == 'finance' %}selected{% endif %}>Finance</option>
                            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="password{{ user.id }}" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="password{{ user.id }}" name="password">
                        <div class="form-text password-help">
                            {% if user.role == 'admin' %}
                            Leave blank to keep current password.
                            {% else %}
                            Password is only required when promoting to admin role.
                            {% endif %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Equipment Access</label>
                        <div class="equipment-checkboxes">
                            {% for equipment in equipment_list %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="equipment[]" value="{{ equipment.id }}" 
                                       id="equipment{{ equipment.id }}_user{{ user.id }}"
                                       {% if equipment in user.equipment %}checked{% endif %}>
                                <label class="form-check-label" for="equipment{{ equipment.id }}_user{{ user.id }}">
                                    {{ equipment.name }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
{% if user.id != session.user_id %}
<div class="modal fade" id="deleteUserModal{{ user.id }}" tabindex="-1" aria-labelledby="deleteUserModalLabel{{ user.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteUserModalLabel{{ user.id }}">Delete User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete user <strong>{{ user.full_name }}</strong>?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete User</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- Add Equipment Modal -->
<div class="modal fade" id="addEquipmentModal" tabindex="-1" aria-labelledby="addEquipmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_equipment') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addEquipmentModalLabel">Add Equipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="equipmentName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="equipmentName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="equipmentDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentManual" class="form-label">Manual URL</label>
                        <input type="url" class="form-control" id="equipmentManual" name="manual" placeholder="https://...">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isSchedulable" name="is_schedulable">
                            <label class="form-check-label" for="isSchedulable">
                                Enable Scheduling
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Equipment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Equipment Modals -->
{% for equipment in equipment_list %}
<div class="modal fade" id="editEquipmentModal{{ equipment.id }}" tabindex="-1" aria-labelledby="editEquipmentModalLabel{{ equipment.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('edit_equipment', equipment_id=equipment.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="editEquipmentModalLabel{{ equipment.id }}">Edit Equipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="equipmentName{{ equipment.id }}" class="form-label">Name</label>
                        <input type="text" class="form-control" id="equipmentName{{ equipment.id }}" name="name" value="{{ equipment.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentDescription{{ equipment.id }}" class="form-label">Description</label>
                        <textarea class="form-control" id="equipmentDescription{{ equipment.id }}" name="description" rows="3">{{ equipment.description or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="equipmentManual{{ equipment.id }}" class="form-label">Manual URL</label>
                        <input type="url" class="form-control" id="equipmentManual{{ equipment.id }}" name="manual" value="{{ equipment.manual or '' }}" placeholder="https://...">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isSchedulable{{ equipment.id }}" name="is_schedulable" {% if equipment.is_schedulable %}checked{% endif %}>
                            <label class="form-check-label" for="isSchedulable{{ equipment.id }}">
                                Enable Scheduling
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Equipment Modal -->
<div class="modal fade" id="deleteEquipmentModal{{ equipment.id }}" tabindex="-1" aria-labelledby="deleteEquipmentModalLabel{{ equipment.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('delete_equipment', equipment_id=equipment.id) }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteEquipmentModalLabel{{ equipment.id }}">Delete Equipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete equipment <strong>{{ equipment.name }}</strong>?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete Equipment</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Global Operating Hours Modal -->
<div class="modal fade" id="operatingHoursModal" tabindex="-1" aria-labelledby="operatingHoursModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('update_operating_hours') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="operatingHoursModalLabel">Set Global Operating Hours</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Day</strong>
                        </div>
                        <div class="col-md-4">
                            <strong>Start Time</strong>
                        </div>
                        <div class="col-md-4">
                            <strong>End Time</strong>
                        </div>
                    </div>
                    {% set days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                    {% for day_num in range(7) %}
                    {% set existing_hours = operating_hours|selectattr('day_of_week', 'equalto', day_num)|first %}
                    <div class="row mb-2">
                        <div class="col-md-4">
                            <label class="form-label">{{ days[day_num] }}</label>
                        </div>
                        <div class="col-md-4">
                            <input type="time" class="form-control" name="start_time_{{ day_num }}" 
                                   value="{{ existing_hours.start_time.strftime('%H:%M') if existing_hours else '' }}">
                        </div>
                        <div class="col-md-4">
                            <input type="time" class="form-control" name="end_time_{{ day_num }}" 
                                   value="{{ existing_hours.end_time.strftime('%H:%M') if existing_hours else '' }}">
                        </div>
                    </div>
                    {% endfor %}
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> Leave start and end times empty to mark a day as closed. These hours apply to all equipment.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Operating Hours</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Global Blocked Date Modal -->
<div class="modal fade" id="addBlockedDateModal" tabindex="-1" aria-labelledby="addBlockedDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_blocked_date') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addBlockedDateModalLabel">Add Global Blocked Date</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="blockedDate" class="form-label">Blocked Date</label>
                        <input type="date" class="form-control" id="blockedDate" name="blocked_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="blockedReason" class="form-label">Reason (Optional)</label>
                        <input type="text" class="form-control" id="blockedReason" name="reason" placeholder="e.g., Holiday, Maintenance">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="annualRecurring" name="is_annual_recurring">
                            <label class="form-check-label" for="annualRecurring">
                                Annual Recurring (e.g., Christmas, New Year)
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <small><i class="bi bi-info-circle"></i> This blocked date will apply to all equipment.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Add Blocked Date</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Appointment Modal -->
<div class="modal fade" id="addAppointmentModal" tabindex="-1" aria-labelledby="addAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="{{ url_for('add_appointment') }}" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAppointmentModalLabel">Create Appointment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appointmentEquipment" class="form-label">Equipment <span class="text-danger">*</span></label>
                                <select class="form-select" id="appointmentEquipment" name="equipment_id" required>
                                    <option value="">Select equipment...</option>
                                    {% for equipment in equipment_list %}
                                        {% if equipment.is_schedulable %}
                                        <option value="{{ equipment.id }}">{{ equipment.name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appointmentUser" class="form-label">User <span class="text-danger">*</span></label>
                                <select class="form-select" id="appointmentUser" name="user_id" required>
                                    <option value="">Select user...</option>
                                    {% for user in users %}
                                        {% if user.role == 'admin' %}
                                        <option value="{{ user.id }}">{{ user.full_name }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="appointmentDate" class="form-label">Date <span class="text-danger">*</span></label>
                                <select class="form-select" id="appointmentDate" name="appointment_date" required>
                                    <option value="">Select date...</option>
                                </select>
                                <div class="form-text">Available dates within booking advance limit</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="appointmentStartTime" class="form-label">Start Time <span class="text-danger">*</span></label>
                                <select class="form-select" id="appointmentStartTime" name="start_time" required>
                                    <option value="">Select start time...</option>
                                </select>
                                <div class="form-text">Available half-hour slots</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="appointmentEndTime" class="form-label">End Time <span class="text-danger">*</span></label>
                                <select class="form-select" id="appointmentEndTime" name="end_time" required>
                                    <option value="">Select end time...</option>
                                </select>
                                <div class="form-text">Must be after start time</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="appointmentPurpose" class="form-label">Purpose</label>
                        <input type="text" class="form-control" id="appointmentPurpose" name="purpose" placeholder="What will this appointment be used for?">
                    </div>
                    <div class="mb-3">
                        <label for="appointmentNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="appointmentNotes" name="notes" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Appointment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function togglePasswordRequired(selectElement, passwordId, currentRole) {
    const passwordInput = document.getElementById(passwordId);
    const helpText = passwordInput.nextElementSibling;
    const selectedRole = selectElement.value;
    
    if (selectedRole === 'admin') {
        if (currentRole && currentRole !== 'admin') {
            // Promoting to admin
            passwordInput.required = true;
            helpText.textContent = 'Password is required when promoting to admin role.';
        } else if (!currentRole) {
            // New admin user
            passwordInput.required = true;
            helpText.textContent = 'Password is required for admin users.';
        } else {
            // Existing admin
            passwordInput.required = false;
            helpText.textContent = 'Leave blank to keep current password.';
        }
    } else {
        passwordInput.required = false;
        helpText.textContent = 'Password is optional for non-admin users.';
    }
}

function updateAppointmentStatus(appointmentId, status) {
    if (confirm(`Are you sure you want to ${status} this appointment?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/appointment/${appointmentId}/status`;
        
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status';
        statusInput.value = status;
        
        form.appendChild(statusInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Initialize password requirements on page load
document.addEventListener('DOMContentLoaded', function() {
    const addRoleSelect = document.getElementById('role');
    if (addRoleSelect) {
        togglePasswordRequired(addRoleSelect, 'password');
    }
    
    // Initialize for edit modals
    document.querySelectorAll('[id^="role"]').forEach(select => {
        if (select.id !== 'role') { // Skip the add user form
            const userId = select.id.replace('role', '');
            togglePasswordRequired(select, 'password' + userId, select.options[select.selectedIndex].value);
        }
    });
    
    // Initialize appointment time selectors
    const appointmentDate = document.getElementById('appointmentDate');
    const startTimeSelect = document.getElementById('appointmentStartTime');
    const endTimeSelect = document.getElementById('appointmentEndTime');
    
    if (appointmentDate && startTimeSelect && endTimeSelect) {
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        appointmentDate.value = today;
        
        // Populate initial time options
        populateTimeOptions();
        
        // Update time options when date changes
        appointmentDate.addEventListener('change', populateTimeOptions);
        startTimeSelect.addEventListener('change', updateEndTimeOptions);
    }
    
    // Initialize appointment form when modal is shown
    const addAppointmentModal = document.getElementById('addAppointmentModal');
    if (addAppointmentModal) {
        addAppointmentModal.addEventListener('shown.bs.modal', function() {
            const modalDate = document.getElementById('appointmentDate');
            const modalStartTime = document.getElementById('appointmentStartTime');
            const modalEndTime = document.getElementById('appointmentEndTime');
            
            if (modalDate && modalStartTime && modalEndTime) {
                // Populate available dates
                populateAvailableDates();
                
                // Update time options when date changes
                modalDate.addEventListener('change', populateTimeOptions);
                modalStartTime.addEventListener('change', updateEndTimeOptions);
            }
        });
    }
});

function populateAvailableDates() {
    const appointmentDate = document.getElementById('appointmentDate');
    const startTimeSelect = document.getElementById('appointmentStartTime');
    const endTimeSelect = document.getElementById('appointmentEndTime');
    
    // Clear existing options
    appointmentDate.innerHTML = '<option value="">Select date...</option>';
    startTimeSelect.innerHTML = '<option value="">Select start time...</option>';
    endTimeSelect.innerHTML = '<option value="">Select end time...</option>';
    
    // Get booking advance limit from scheduling settings
    const bookingAdvanceLimit = {{ scheduling_settings.booking_advance_limit_days }};
    const operatingHoursData = {{ operating_hours_js|tojson }};
    
    const today = new Date();
    const availableDates = [];
    
    // Generate dates within the advance limit
    for (let i = 0; i <= bookingAdvanceLimit; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        // Get day of week (0=Sunday, 1=Monday, etc.)
        const dayOfWeek = date.getDay();
        // Convert to our database format (0=Monday, 1=Tuesday, etc.)
        const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
        
        // Check if we have operating hours for this day
        const dayHours = operatingHoursData[dayIndex];
        if (dayHours && dayHours.start_time && dayHours.end_time) {
            const dateString = date.toISOString().split('T')[0];
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[dayOfWeek];
            
            const option = document.createElement('option');
            option.value = dateString;
            option.textContent = `${dayName}, ${dateString}`;
            appointmentDate.appendChild(option);
            availableDates.push({ date: dateString, dayIndex: dayIndex });
        }
    }
    
    // Set default to first available date
    if (availableDates.length > 0) {
        appointmentDate.value = availableDates[0].date;
        populateTimeOptions();
    }
}

function populateTimeOptions() {
    const appointmentDate = document.getElementById('appointmentDate');
    const startTimeSelect = document.getElementById('appointmentStartTime');
    const endTimeSelect = document.getElementById('appointmentEndTime');
    
    if (!appointmentDate.value) return;
    
    // Parse date in local timezone to avoid timezone issues
    const [year, month, day] = appointmentDate.value.split('-').map(Number);
    const selectedDate = new Date(year, month - 1, day); // month is 0-indexed
    const now = new Date();
    const isToday = selectedDate.toDateString() === now.toDateString();
    
    console.log(`Selected date string: ${appointmentDate.value}`);
    console.log(`Parsed date object: ${selectedDate}`);
    console.log(`Date string: ${selectedDate.toDateString()}`);
    
    // Get day of week (0=Sunday, 1=Monday, etc.)
    const dayOfWeek = selectedDate.getDay();
    // Convert to our database format (0=Monday, 1=Tuesday, etc.)
    // JavaScript: Sunday=0, Monday=1, Tuesday=2, etc.
    // Database: Monday=0, Tuesday=1, Wednesday=2, etc.
    const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    
    console.log(`Date: ${appointmentDate.value}, JavaScript day: ${dayOfWeek}, Calculated index: ${dayIndex}`);
    
    // Get operating hours for this day
    const operatingHours = getOperatingHoursForDay(dayIndex);
    
    // Debug: Check if operating hours exist
    if (!operatingHours) {
        console.error(`No operating hours found for day ${dayIndex}`);
        startTimeSelect.innerHTML = '<option value="">No operating hours</option>';
        endTimeSelect.innerHTML = '<option value="">No operating hours</option>';
        startTimeSelect.disabled = true;
        endTimeSelect.disabled = true;
        return;
    }
    
    // Enable selects and clear options
    startTimeSelect.disabled = false;
    endTimeSelect.disabled = false;
    startTimeSelect.innerHTML = '<option value="">Select start time...</option>';
    endTimeSelect.innerHTML = '<option value="">Select end time...</option>';
    
    // Generate time slots within operating hours
    const timeSlots = [];
    const startHour = parseInt(operatingHours.start_time.split(':')[0]);
    const startMinute = parseInt(operatingHours.start_time.split(':')[1]);
    const endHour = parseInt(operatingHours.end_time.split(':')[0]);
    const endMinute = parseInt(operatingHours.end_time.split(':')[1]);
    
    let currentHour = startHour;
    let currentMinute = startMinute;
    
    while (currentHour < endHour || (currentHour === endHour && currentMinute < endMinute)) {
        const timeString = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
        timeSlots.push(timeString);
        
        currentMinute += 30;
        if (currentMinute >= 60) {
            currentHour += 1;
            currentMinute = 0;
        }
    }
    
    // Add start time options
    timeSlots.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        
        // If it's today, disable past times
        if (isToday) {
            const timeDate = new Date(`${appointmentDate.value}T${time}`);
            if (timeDate <= now) {
                option.disabled = true;
                option.textContent += ' (past)';
            }
        }
        
        startTimeSelect.appendChild(option);
    });
    
    // Set default start time to next available slot
    if (isToday) {
        const nextSlot = getNextAvailableTimeSlot(operatingHours);
        if (nextSlot) {
            startTimeSelect.value = nextSlot;
            updateEndTimeOptions();
        }
    }
}

function updateEndTimeOptions() {
    const startTimeSelect = document.getElementById('appointmentStartTime');
    const endTimeSelect = document.getElementById('appointmentEndTime');
    const appointmentDate = document.getElementById('appointmentDate');
    
    if (!startTimeSelect.value || !appointmentDate.value) {
        endTimeSelect.innerHTML = '<option value="">Select end time...</option>';
        return;
    }
    
    // Get operating hours for the selected date
    const [year, month, day] = appointmentDate.value.split('-').map(Number);
    const selectedDate = new Date(year, month - 1, day); // month is 0-indexed
    const dayOfWeek = selectedDate.getDay();
    const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    const operatingHours = getOperatingHoursForDay(dayIndex);
    
    if (!operatingHours) {
        endTimeSelect.innerHTML = '<option value="">No operating hours</option>';
        return;
    }
    
    // Clear existing options
    endTimeSelect.innerHTML = '<option value="">Select end time...</option>';
    
    // Parse start time and operating hours
    const [startHour, startMinute] = startTimeSelect.value.split(':').map(Number);
    const endHour = parseInt(operatingHours.end_time.split(':')[0]);
    const endMinute = parseInt(operatingHours.end_time.split(':')[1]);
    
    let currentHour = startHour;
    let currentMinute = startMinute;
    
    // Generate end time options (in half-hour increments)
    // For admins, allow longer appointments - up to end of operating hours
    for (let i = 1; i <= 32; i++) { // Up to 16 hours later
        currentMinute += 30;
        if (currentMinute >= 60) {
            currentHour += 1;
            currentMinute = 0;
        }
        
        // Stop at end of operating hours
        if (currentHour > endHour || (currentHour === endHour && currentMinute >= endMinute)) {
            break;
        }
        
        const timeString = `${currentHour.toString().padStart(2, '0')}:${currentMinute.toString().padStart(2, '0')}`;
        const option = document.createElement('option');
        option.value = timeString;
        option.textContent = timeString;
        endTimeSelect.appendChild(option);
    }
}

function getOperatingHoursForDay(dayIndex) {
    // Get operating hours from server data
    const operatingHoursData = {{ operating_hours_js|tojson }};
    console.log('All operating hours data:', operatingHoursData);
    console.log(`Getting hours for day ${dayIndex}:`, operatingHoursData[dayIndex]);
    return operatingHoursData[dayIndex];
}

function getNextAvailableTimeSlot(operatingHours) {
    if (!operatingHours) return null;
    
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    
    // Calculate next half-hour slot
    let nextHour = currentHour;
    let nextMinute = currentMinute < 30 ? 30 : 0;
    
    if (nextMinute === 0) {
        nextHour += 1;
    }
    
    // Ensure we're within operating hours
    const startHour = parseInt(operatingHours.start_time.split(':')[0]);
    const startMinute = parseInt(operatingHours.start_time.split(':')[1]);
    const endHour = parseInt(operatingHours.end_time.split(':')[0]);
    const endMinute = parseInt(operatingHours.end_time.split(':')[1]);
    
    if (nextHour < startHour || (nextHour === startHour && nextMinute < startMinute)) {
        nextHour = startHour;
        nextMinute = startMinute;
    } else if (nextHour > endHour || (nextHour === endHour && nextMinute >= endMinute)) {
        return null; // No more slots today
    }
    
    return `${nextHour.toString().padStart(2, '0')}:${nextMinute.toString().padStart(2, '0')}`;
}


</script>
{% endblock %} 