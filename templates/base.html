<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Hub Tracker{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    {% if session.user_id %}
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4 class="sidebar-logo text-white mb-0">
                <span class="logo-hub">Hub</span><span class="logo-tracker">Tracker</span>
            </h4>
        </div>
        
        <div class="sidebar-nav">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}" href="{{ url_for('dashboard') }}">
                        <i class="bi bi-speedometer2 me-2"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'tasks' %}active{% endif %}" href="{{ url_for('tasks') }}">
                        <i class="bi bi-list-task me-2"></i>Tasks
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'projects' %}active{% endif %}" href="{{ url_for('projects') }}">
                        <i class="bi bi-hash me-2"></i>Projects
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'clients' %}active{% endif %}" href="{{ url_for('clients') }}">
                        <i class="bi bi-people me-2"></i>Clients
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'memberships' %}active{% endif %}" href="{{ url_for('memberships') }}">
                        <i class="bi bi-card-list me-2"></i>Memberships
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'analytics' %}active{% endif %}" href="{{ url_for('analytics') }}">
                        <i class="bi bi-graph-up me-2"></i>Analytics
                    </a>
                </li>
                {% if session.is_admin %}
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'users' %}active{% endif %}" href="{{ url_for('users') }}">
                        <i class="bi bi-person-gear me-2"></i>Users
                    </a>
                </li>
                {% endif %}
            </ul>
            
            <!-- Pinned Projects Section -->
            {% if session.user_id %}
            {% set pinned_projects = get_pinned_projects() %}
            {% if pinned_projects %}
            <div class="sidebar-section mt-4">
                <div class="sidebar-section-header px-3">
                    <h6 class="text-white-50 text-uppercase small fw-bold mb-2">
                        <i class="bi bi-pin me-1"></i>Pinned Projects
                    </h6>
                </div>
                <div class="pinned-projects-list">
                    {% for project in pinned_projects %}
                    <a class="pinned-project-item {% if request.endpoint == 'project_detail' and request.view_args.get('project_id') == project.id %}active{% endif %}" 
                       href="{{ url_for('project_detail', project_id=project.id) }}">
                        <div class="project-content">
                            <div class="project-name">{{ project.name }}</div>
                            <small class="text-white-50">{{ project.client.name }}</small>
                        </div>
                        {% if project.open_tasks_count > 0 %}
                        <span class="task-count-bubble">{{ project.open_tasks_count }}</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <a href="{{ url_for('profile') }}" class="text-white text-decoration-none">
                    <div class="text-white fw-bold">{{ session.user_name }}</div>
                    <small class="text-white-50">Edit Profile</small>
                </a>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm mt-2">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="main-content {% if session.user_id %}with-sidebar{% endif %}">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container {% if request.endpoint == 'login' %}login-page-messages{% endif %}" id="flash-container">
                    <div class="container-fluid">
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" onclick="checkEmptyContainer()"></button>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        {% endwith %}

        <!-- Page Content -->
        {% block content %}{% endblock %}
    </div>

    <!-- Log Entry Button -->
    {% if session.user_id %}
    <div x-data="logEntryModal()" x-init="$nextTick(() => loadProjects())">
        <div class="floating-action-btn">
            <div class="log-button-attention-wrapper">
                <button class="fab-main {{ 'log-button-attention' if not has_logged_today }}" 
                        type="button" 
                        data-bs-toggle="modal"
                        data-bs-target="#logEntryModal"
                        title="Log Time or Touch">
                    <i class="bi bi-clock"></i>
                </button>
            </div>
        </div>
        
        <!-- Log Entry Modal -->
        <div class="modal fade" id="logEntryModal" tabindex="-1" aria-labelledby="logEntryModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="logEntryModalLabel">Log Effort</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Project Search -->
                        <div class="mb-3 position-relative">
                            <input 
                                type="text" 
                                class="form-control" 
                                id="projectSearch" 
                                x-model="searchQuery"
                                @input="filterProjects()"
                                placeholder="Filter by project..."
                                x-ref="searchInput"
                            >
                        </div>
                        
                        <!-- Projects List -->
                        <div class="projects-list" style="max-height: 400px; overflow-y: auto;">
                            <template x-for="project in filteredProjects" :key="project.id">
                                <div class="project-item border-bottom pb-2 mb-2 position-relative project-touch-area" @click="touchLog(project)" style="cursor: pointer;">
                                    <!-- Touch overlay for entire card -->
                                    <div class="touch-overlay">
                                        <i class="bi bi-fingerprint"></i>
                                        <span>Touch Project</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <!-- Project content -->
                                        <div class="flex-grow-1">
                                            <div class="fw-bold" x-text="project.name"></div>
                                            <small class="text-muted" x-text="project.client_name"></small>
                                        </div>
                                        <!-- Time Log Button - positioned to the right -->
                                        <button 
                                            type="button" 
                                            class="log-time-btn"
                                            @click.stop="openTimeLogForm(project)"
                                            title="Detailed Time Log"
                                        >
                                            <i class="bi bi-clock"></i>
                                        </button>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="filteredProjects.length === 0" class="text-center text-muted py-4">
                                <div x-show="searchQuery === ''">Loading projects...</div>
                                <div x-show="searchQuery !== ''">No projects found matching your search.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Time Log Form Modal -->
    <div class="modal fade" id="timeLogModal" tabindex="-1" aria-labelledby="timeLogModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="{{ url_for('add_time_log') }}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="timeLogModalLabel">Log Effort</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <div id="selectedProjectInfo">
                                <div id="selectedProjectName" class="fw-bold"></div>
                                <small id="selectedClientName" class="text-muted"></small>
                            </div>
                            <input type="hidden" name="project_id" id="selectedProjectId">
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="hours" class="form-label">Hours</label>
                                <input type="number" class="form-control" id="hours" name="hours" step="0.01" min="0" max="24">
                                <div class="form-text">Optional - Hours worked</div>
                            </div>
                            <div class="col-md-6">
                                <label for="fixed_cost" class="form-label">Fixed Cost</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="fixed_cost" name="fixed_cost" step="0.01" min="0">
                                </div>
                                <div class="form-text">Optional - Fixed amount</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" required></textarea>
                            <div class="form-text">Required - Describe the work performed</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Log Time</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Alpine.js with Collapse Plugin -->
    <script defer src="https://unpkg.com/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Task Form Alpine Component -->
    <script>
        function taskForm() {
            return {
                rawInput: '',
                cleanDescription: '',
                projects: [],
                users: [],
                selectedProject: {},
                selectedUser: {},
                showAutocomplete: false,
                autocompleteType: '', // 'project' or 'user'
                filteredItems: [],
                selectedIndex: 0,
                editMode: false,
                editTaskId: null,
                _settingEditData: false,
                
                async init() {
                    // Load projects and users
                    await this.loadData();
                    // Set default project
                    this.setDefaultProject();
                    // Ensure input is focused
                    this.$nextTick(() => {
                        this.$refs.taskInput.focus();
                    });
                },
                
                async loadData() {
                    try {
                        const [projectsRes, usersRes] = await Promise.all([
                            fetch('/api/projects'),
                            fetch('/api/users')
                        ]);
                        
                        const projectsData = await projectsRes.json();
                        const usersData = await usersRes.json();
                        
                        this.projects = projectsData.projects || [];
                        this.users = usersData.users || [];
                    } catch (error) {
                        console.error('Failed to load data:', error);
                    }
                },
                
                setDefaultProject() {
                    const defaultProject = this.projects.find(p => p.is_default);
                    if (defaultProject) {
                        this.selectedProject = defaultProject;
                    }
                },
                
                parseInput() {
                    // Skip parsing if we're in the middle of setting edit data
                    if (this._settingEditData) {
                        return;
                    }
                    
                    const input = this.rawInput;
                    let cleanDesc = input;
                    
                    // Reset autocomplete
                    this.showAutocomplete = false;
                    
                    // In edit mode, be more careful about overriding existing assignments
                    const inEditMode = this.editMode;
                    
                    // Check for # (project) - handle multi-word projects with brackets
                    const projectMatch = input.match(/#\[([^\]]*)\]|#([^\s@\[]*)/);
                    if (projectMatch) {
                        const query = projectMatch[1] || projectMatch[2]; // Bracket content or single word
                        if (query && query.length > 0 && !projectMatch[1]) { // Only show autocomplete for incomplete tags
                            this.showProjectAutocomplete(query);
                        }
                        // Remove project tag from description
                        cleanDesc = cleanDesc.replace(/#\[[^\]]*\]|\s*#[^\s@\[]*\s?/, '').trim();
                    } else if (!inEditMode) {
                        // Only reset to default project if not in edit mode
                        this.setDefaultProject();
                    }
                    
                    // Check for @ (user) - handle multi-word names with brackets
                    const userMatch = input.match(/@\[([^\]]*)\]|@([^\s#\[]*)/);
                    if (userMatch) {
                        const query = userMatch[1] || userMatch[2]; // Bracket content or single word
                        if (query && query.length > 0 && !userMatch[1]) { // Only show autocomplete for incomplete tags
                            this.showUserAutocomplete(query);
                        }
                        // Remove user tag from description
                        cleanDesc = cleanDesc.replace(/@\[[^\]]*\]|\s*@[^\s#\[]*\s?/, '').trim();
                    } else if (!inEditMode) {
                        // Only clear user assignment if not in edit mode
                        this.selectedUser = {};
                    }
                    
                    this.cleanDescription = cleanDesc;
                },
                
                showProjectAutocomplete(query) {
                    this.autocompleteType = 'project';
                    this.filteredItems = this.projects.filter(p => 
                        p.display_name.toLowerCase().includes(query.toLowerCase())
                    ).slice(0, 5);
                    this.showAutocomplete = this.filteredItems.length > 0;
                    this.selectedIndex = 0;
                },
                
                showUserAutocomplete(query) {
                    this.autocompleteType = 'user';
                    this.filteredItems = this.users.filter(u => 
                        u.name.toLowerCase().includes(query.toLowerCase())
                    ).slice(0, 5);
                    this.showAutocomplete = this.filteredItems.length > 0;
                    this.selectedIndex = 0;
                },
                
                selectItem(item) {
                    if (this.autocompleteType === 'project') {
                        this.selectedProject = item;
                        // Replace #query with bracketed project name for multi-word support
                        this.rawInput = this.rawInput.replace(/#[^\s@\[]*/, `#[${item.name}] `);
                    } else if (this.autocompleteType === 'user') {
                        this.selectedUser = item;
                        // Replace @query with bracketed user name
                        this.rawInput = this.rawInput.replace(/@[^\s#\[]*/, `@[${item.name}] `);
                    }
                    
                    this.showAutocomplete = false;
                    this.selectedIndex = 0;
                    
                    // Focus back to input and move cursor to end
                    this.$nextTick(() => {
                        this.$refs.taskInput.focus();
                        const input = this.$refs.taskInput;
                        input.setSelectionRange(input.value.length, input.value.length);
                    });
                },
                
                handleKeydown(event) {
                    // Handle autocomplete navigation
                    if (this.showAutocomplete) {
                        switch (event.key) {
                            case 'ArrowDown':
                                event.preventDefault();
                                this.selectedIndex = (this.selectedIndex + 1) % this.filteredItems.length;
                                break;
                            case 'ArrowUp':
                                event.preventDefault();
                                this.selectedIndex = this.selectedIndex === 0 ? 
                                    this.filteredItems.length - 1 : this.selectedIndex - 1;
                                break;
                            case 'Enter':
                                if (this.filteredItems[this.selectedIndex]) {
                                    event.preventDefault();
                                    this.selectItem(this.filteredItems[this.selectedIndex]);
                                }
                                break;
                            case 'Escape':
                                this.showAutocomplete = false;
                                break;
                        }
                        return;
                    }

                    // Handle tag deletion with backspace
                    if (event.key === 'Backspace') {
                        this.handleTagDeletion(event);
                    }
                },

                handleTagDeletion(event) {
                    const input = event.target;
                    const cursorPos = input.selectionStart;
                    const value = input.value;
                    
                    // If cursor is at the start of input, nothing to delete
                    if (cursorPos === 0) return;
                    
                    // Find tags that end at or near the cursor position
                    const projectTagRegex = /#\[[^\]]*\]/g;
                    const userTagRegex = /@\[[^\]]*\]/g;
                    
                    let match;
                    let tagToDelete = null;
                    
                    // Check for project tags
                    while ((match = projectTagRegex.exec(value)) !== null) {
                        const tagEnd = match.index + match[0].length;
                        if (tagEnd === cursorPos || (tagEnd === cursorPos - 1 && value[cursorPos] === ' ')) {
                            tagToDelete = { start: match.index, end: tagEnd, type: 'project' };
                            break;
                        }
                    }
                    
                    // Check for user tags if no project tag found
                    if (!tagToDelete) {
                        while ((match = userTagRegex.exec(value)) !== null) {
                            const tagEnd = match.index + match[0].length;
                            if (tagEnd === cursorPos || (tagEnd === cursorPos - 1 && value[cursorPos] === ' ')) {
                                tagToDelete = { start: match.index, end: tagEnd, type: 'user' };
                                break;
                            }
                        }
                    }
                    
                    // If we found a tag to delete, remove it entirely
                    if (tagToDelete) {
                        event.preventDefault();
                        const newValue = value.slice(0, tagToDelete.start) + value.slice(tagToDelete.end).replace(/^\s+/, '');
                        this.rawInput = newValue;
                        
                        // Reset selections based on what was deleted
                        if (tagToDelete.type === 'project') {
                            this.setDefaultProject();
                        } else if (tagToDelete.type === 'user') {
                            this.selectedUser = {};
                        }
                        
                        // Move cursor to where tag started
                        this.$nextTick(() => {
                            input.setSelectionRange(tagToDelete.start, tagToDelete.start);
                            this.parseInput();
                        });
                    }
                },
                
                onSubmit() {
                    // Store the original input with tags for submission
                    this.$refs.originalInput.value = this.rawInput;
                    // Submit the raw input with tags instead of clean description
                    this.parseInput();
                    this.$refs.taskInput.value = this.rawInput;
                    
                    // If in edit mode, close modal after submission
                    if (this.editMode) {
                        setTimeout(() => {
                            const modal = document.getElementById('taskModal');
                            if (modal) {
                                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                                if (bootstrapModal) {
                                    bootstrapModal.hide();
                                }
                            }
                        }, 100);
                    }
                },
                
                handlePresetProject(event) {
                    console.log('handlePresetProject called:', event.detail);
                    const { projectId, projectName, lookupByName } = event.detail;
                    
                    // Find the project in our loaded data
                    let project = null;
                    if (lookupByName) {
                        // Find project by name
                        project = this.projects.find(p => p.name === projectName);
                    } else if (projectId) {
                        // Find project by ID
                        project = this.projects.find(p => p.id == projectId);
                    }
                    
                    if (project) {
                        this.selectedProject = project;
                        this.rawInput = `#[${project.name}] `;
                        console.log('Project set via event:', project);
                    } else {
                        console.log('Project not found, creating fallback');
                        // Fallback - create a minimal project object
                        this.selectedProject = {
                            id: projectId,
                            name: projectName,
                            display_name: projectName
                        };
                        this.rawInput = `#[${projectName}] `;
                    }
                    
                    // Focus the input after setting
                    this.$nextTick(() => {
                        this.$refs.taskInput.focus();
                        if (this.rawInput) {
                            this.$refs.taskInput.setSelectionRange(this.rawInput.length, this.rawInput.length);
                        }
                    });
                },
                
                handlePresetUser(event) {
                    console.log('handlePresetUser called:', event.detail);
                    const { userId, userName } = event.detail;
                    
                    // Find the user in our loaded data
                    const user = this.users.find(u => u.id == userId);
                    if (user) {
                        this.selectedUser = user;
                        this.rawInput = `@[${user.name}] `;
                        console.log('User set via event:', user);
                    } else {
                        console.log('User not found, creating fallback');
                        // Fallback - create a minimal user object
                        this.selectedUser = {
                            id: userId,
                            name: userName
                        };
                        this.rawInput = `@[${userName}] `;
                    }
                    
                    // Focus the input after setting
                    this.$nextTick(() => {
                        this.$refs.taskInput.focus();
                        if (this.rawInput) {
                            this.$refs.taskInput.setSelectionRange(this.rawInput.length, this.rawInput.length);
                        }
                    });
                },
                
                handleEditTask(event) {
                    console.log('handleEditTask called:', event.detail);
                    const { taskId, description, projectId, projectName, userId, userName } = event.detail;
                    
                    // Set edit mode
                    this.editMode = true;
                    this.editTaskId = taskId;
                    
                    console.log('Available projects:', this.projects.length);
                    console.log('Looking for project:', { projectId, projectName });
                    
                    // Set project if provided
                    if (projectId && projectId !== 'lookup' && projectName) {
                        const project = this.projects.find(p => p.id == projectId);
                        console.log('Found project by ID:', project);
                        if (project) {
                            this.selectedProject = project;
                        } else {
                            // Create fallback project object
                            this.selectedProject = {
                                id: projectId,
                                name: projectName,
                                display_name: projectName
                            };
                        }
                    } else if (projectName) {
                        // Try to find project by name if no ID provided
                        const project = this.projects.find(p => p.name === projectName);
                        console.log('Found project by name:', project);
                        if (project) {
                            this.selectedProject = project;
                        } else {
                            // Create fallback project object
                            this.selectedProject = {
                                id: null,
                                name: projectName,
                                display_name: projectName
                            };
                        }
                    } else {
                        this.selectedProject = {};
                    }
                    
                    console.log('Final selectedProject:', this.selectedProject);
                    console.log('selectedProject has id?', !!this.selectedProject.id);
                    console.log('selectedProject has name?', !!this.selectedProject.name);
                    
                    // If no project found in database, try parsing from description
                    if ((!this.selectedProject || (!this.selectedProject.id && !this.selectedProject.name)) && description) {
                        console.log('No project found, trying to parse from description:', description);
                        console.log('Available projects:', this.projects);
                        console.log('projects length:', this.projects ? this.projects.length : 'undefined');
                        
                        const projectMatch = description.match(/#\[([^\]]+)\]/);
                        if (projectMatch) {
                            const parsedProjectName = projectMatch[1];
                            console.log('Found project tag in description:', parsedProjectName);
                            
                            // Check if projects are loaded
                            if (this.projects && this.projects.length > 0) {
                                // Try to find this project in our available projects
                                const foundProject = this.projects.find(p => 
                                    p.name.toLowerCase() === parsedProjectName.toLowerCase()
                                );
                                
                                if (foundProject) {
                                    console.log('Matched project from description:', foundProject);
                                    this.selectedProject = foundProject;
                                } else {
                                    console.log('Project name from description not found in available projects:', parsedProjectName);
                                    console.log('Available project names:', this.projects.map(p => p.name));
                                    // Create a minimal project object for display
                                    this.selectedProject = {
                                        id: null,
                                        name: parsedProjectName,
                                        display_name: parsedProjectName
                                    };
                                    console.log('Created minimal project object:', this.selectedProject);
                                }
                            } else {
                                console.log('Projects not loaded yet, creating minimal project object');
                                // Create a minimal project object for display
                                this.selectedProject = {
                                    id: null,
                                    name: parsedProjectName,
                                    display_name: parsedProjectName
                                };
                                console.log('Created minimal project object:', this.selectedProject);
                            }
                        }
                    }
                    
                    // Final backup: If we have projectName but no valid selectedProject, create a minimal one
                    if (projectName && (!this.selectedProject || (!this.selectedProject.id && !this.selectedProject.name))) {
                        console.log('Creating backup project object for:', projectName);
                        this.selectedProject = {
                            id: projectId && projectId !== 'lookup' ? projectId : null,
                            name: projectName,
                            display_name: projectName
                        };
                        console.log('Backup selectedProject created:', this.selectedProject);
                    }
                    
                    // Set user if provided
                    if (userId && userName) {
                        const user = this.users.find(u => u.id == userId);
                        console.log('Found user:', user);
                        if (user) {
                            this.selectedUser = user;
                        } else {
                            // Create fallback user object
                            this.selectedUser = {
                                id: userId,
                                name: userName
                            };
                        }
                    } else {
                        this.selectedUser = {};
                    }
                    
                    console.log('Final selectedUser:', this.selectedUser);
                    
                    // Pre-populate the form with existing task data AFTER setting assignments
                    // This prevents parseInput from overriding our manual assignments
                    // Temporarily disable parsing during edit setup
                    this._settingEditData = true;
                    this.rawInput = description;
                    
                    // Force a Vue reactivity update to ensure template sees the changes
                    this.$nextTick(() => {
                        this._settingEditData = false;
                        console.log('After setting rawInput, selectedProject:', this.selectedProject);
                        console.log('After setting rawInput, selectedUser:', this.selectedUser);
                        console.log('selectedProject condition check:', this.selectedProject && (this.selectedProject.id || this.selectedProject.name));
                    });
                    
                    // Focus the input after setting
                    this.$nextTick(() => {
                        this.$refs.taskInput.focus();
                        if (this.rawInput) {
                            this.$refs.taskInput.setSelectionRange(this.rawInput.length, this.rawInput.length);
                        }
                    });
                },
                
                resetForm() {
                    this.editMode = false;
                    this.editTaskId = null;
                    this.rawInput = '';
                    this.selectedProject = {};
                    this.selectedUser = {};
                    this.showAutocomplete = false;
                    this.setDefaultProject();
                }
            }
        }

        // Task List Alpine Component
        function taskList(sectionId) {
            return {
                sectionId: sectionId,
                tasks: [],
                filteredTasks: [],
                searchQuery: '',
                currentUserId: null,
                tasksICreated: [],
                showTasksICreated: false,
                showCompletedTasks: false,
                
                init() {
                    // Read task data from script tag
                    const dataScript = document.getElementById('tasks-data');
                    if (dataScript) {
                        try {
                            const tasksData = JSON.parse(dataScript.textContent);
                            if (this.sectionId === 'tasks-for-me') {
                                this.tasks = tasksData.tasksForMe;
                                this.tasksICreated = tasksData.tasksICreated; // Load tasks by me for reference
                            } else if (this.sectionId === 'all-tasks') {
                                this.tasks = tasksData.allTasks;
                            } else if (this.sectionId === 'completed-tasks') {
                                this.tasks = tasksData.completedTasks;
                            } else if (this.sectionId === 'client-tasks' || this.sectionId === 'project-tasks') {
                                this.tasks = tasksData.allTasks; // Use allTasks for detail pages
                            }
                            this.currentUserId = tasksData.currentUserId;
                            console.log(`TaskList ${this.sectionId} initialized with ${this.tasks.length} tasks:`, this.tasks);
                        } catch (error) {
                            console.error('Failed to parse task data:', error);
                            this.tasks = [];
                        }
                    }
                    
                    this.filteredTasks = [...this.tasks];
                    console.log(`Filtered tasks now:`, this.filteredTasks);
                },
                
                isAssignedToMe(task) {
                    // Check if task is assigned to the current logged-in user
                    return task.assigned_to_id === this.currentUserId;
                },
                
                getDisplayDescription(task) {
                    // Use server-side formatted description if available, otherwise fall back to clean description
                    if (task.formatted_description) {
                        return task.formatted_description;
                    }
                    return task.description || '';
                },
                
                filterTasks() {
                    if (!this.searchQuery.trim()) {
                        this.filteredTasks = [...this.tasks];
                        return;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    this.filteredTasks = this.tasks.filter(task => {
                        return task.description.toLowerCase().includes(query) ||
                               (task.project_name && task.project_name.toLowerCase().includes(query)) ||
                               (task.client_name && task.client_name.toLowerCase().includes(query)) ||
                               (task.assigned_to_name && task.assigned_to_name.toLowerCase().includes(query)) ||
                               (task.creator_name && task.creator_name.toLowerCase().includes(query));
                    });
                },
                
                getTasksByProject() {
                    // Group tasks by project for the All Tasks section
                    if (this.sectionId !== 'all-tasks') {
                        return null;
                    }
                    
                    const grouped = {};
                    this.filteredTasks.forEach(task => {
                        const projectKey = task.project_name || 'No Project';
                        if (!grouped[projectKey]) {
                            grouped[projectKey] = [];
                        }
                        grouped[projectKey].push(task);
                    });
                    
                    // Convert to sorted array
                    return Object.keys(grouped)
                        .sort()
                        .map(projectName => ({
                            name: projectName,
                            tasks: grouped[projectName]
                        }));
                },
                
                clearSearch() {
                    this.searchQuery = '';
                    this.filterTasks();
                },
                
                formatDate(dateString) {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    const now = new Date();
                    const diffTime = now - date;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 0) {
                        const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
                        if (diffHours < 1) {
                            const diffMinutes = Math.floor(diffTime / (1000 * 60));
                            return diffMinutes < 1 ? 'Just now' : `${diffMinutes}m ago`;
                        }
                        return `${diffHours}h ago`;
                    } else if (diffDays === 1) {
                        return 'Yesterday';
                    } else if (diffDays < 7) {
                        return `${diffDays}d ago`;
                    } else {
                        return date.toLocaleDateString();
                    }
                },
                
                editTask(task) {
                    console.log('editTask called with task:', task);
                    console.log('task.project_id:', task.project_id);
                    console.log('task.project_name:', task.project_name);
                    console.log('task.assigned_to_id:', task.assigned_to_id);
                    console.log('task.assigned_to_name:', task.assigned_to_name);
                    
                    // Open the task modal in edit mode using the smart task form
                    const modal = document.getElementById('taskModal');
                    
                    // Store task edit data to be used by the task form when modal is shown
                    modal.dataset.editTaskId = task.id;
                    modal.dataset.editDescription = task.description;
                    // Use the actual project data if available, fall back to lookup by name
                    modal.dataset.editProjectId = task.project_id || (task.project_name ? 'lookup' : '');
                    modal.dataset.editProjectName = task.project_name || '';
                    modal.dataset.editUserId = task.assigned_to_id || '';
                    modal.dataset.editUserName = task.assigned_to_name || '';
                    
                    console.log('Modal dataset set:', {
                        editProjectId: modal.dataset.editProjectId,
                        editProjectName: modal.dataset.editProjectName,
                        editUserId: modal.dataset.editUserId,
                        editUserName: modal.dataset.editUserName
                    });
                    
                    // Show the modal
                    const bootstrapModal = new bootstrap.Modal(modal);
                    bootstrapModal.show();
                },
                
                addTaskToProject(projectGroup) {
                    // Get the first task to extract project information
                    if (projectGroup.tasks && projectGroup.tasks.length > 0) {
                        const firstTask = projectGroup.tasks[0];
                        if (firstTask.project_name && firstTask.project_name !== 'No Project') {
                            // Find the project ID from the first task in this group
                            // We need to make an educated guess or find it from task data
                            // For now, we'll just use the project name
                            openTaskModalWithProjectName(firstTask.project_name);
                        }
                    }
                }
            }
        }
        
        // Log Entry Modal Alpine Component
        function logEntryModal() {
            return {
                searchQuery: '',
                allProjects: [],
                filteredProjects: [],
                
                async openModal() {
                    console.log('openModal called');
                    
                    // Load projects when modal opens
                    await this.loadProjects();
                    console.log('Projects loaded:', this.allProjects.length);
                    
                    // Clear any previous search
                    this.searchQuery = '';
                    this.filteredProjects = [...this.allProjects];
                    
                    // Show the modal
                    const modalElement = document.getElementById('logEntryModal');
                    console.log('Modal element:', modalElement);
                    
                    const modal = new bootstrap.Modal(modalElement);
                    
                    // Listen for when modal is hidden to clear search (with cleanup)
                    const clearSearchOnHide = () => {
                        this.searchQuery = '';
                        this.filteredProjects = [...this.allProjects];
                        modalElement.removeEventListener('hidden.bs.modal', clearSearchOnHide);
                    };
                    modalElement.addEventListener('hidden.bs.modal', clearSearchOnHide);
                    
                    modal.show();
                    
                    // Focus on search input
                    this.$nextTick(() => {
                        this.$refs.searchInput.focus();
                    });
                },
                
                async loadProjects() {
                    try {
                        const response = await fetch('/api/projects_for_logging');
                        const data = await response.json();
                        this.allProjects = data.projects || [];
                        this.filteredProjects = [...this.allProjects];
                    } catch (error) {
                        console.error('Failed to load projects:', error);
                        this.allProjects = [];
                        this.filteredProjects = [];
                    }
                },
                
                filterProjects() {
                    if (!this.searchQuery.trim()) {
                        this.filteredProjects = [...this.allProjects];
                        return;
                    }
                    
                    const query = this.searchQuery.toLowerCase();
                    this.filteredProjects = this.allProjects.filter(project => 
                        project.name.toLowerCase().includes(query) ||
                        project.client_name.toLowerCase().includes(query) ||
                        project.display_name.toLowerCase().includes(query)
                    );
                },
                
                async touchLog(project) {
                    try {
                        const response = await fetch('/add_touch_log', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                project_id: project.id
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            // Close the modal
                            const modal = bootstrap.Modal.getInstance(document.getElementById('logEntryModal'));
                            modal.hide();
                            
                            // Trigger confetti!
                            confetti({
                                particleCount: 100,
                                spread: 70,
                                origin: { y: 0.6 }
                            });
                        } else {
                            this.showErrorMessage(result.error || 'Failed to log touch');
                        }
                    } catch (error) {
                        console.error('Touch log error:', error);
                        this.showErrorMessage('Failed to log touch');
                    }
                },
                
                openTimeLogForm(project) {
                    // Clear form fields first
                    document.getElementById('hours').value = '';
                    document.getElementById('fixed_cost').value = '';
                    document.getElementById('notes').value = '';
                    
                    // Populate project info in the time log form - match search list styling
                    document.getElementById('selectedProjectName').textContent = project.name;
                    document.getElementById('selectedClientName').textContent = project.client_name;
                    document.getElementById('selectedProjectId').value = project.id;
                    
                    // Close log entry modal
                    const logModal = bootstrap.Modal.getInstance(document.getElementById('logEntryModal'));
                    logModal.hide();
                    
                    // Open time log modal with proper focus handling
                    const timeModal = new bootstrap.Modal(document.getElementById('timeLogModal'));
                    
                    // Listen for when the modal is fully shown
                    document.getElementById('timeLogModal').addEventListener('shown.bs.modal', function focusHours() {
                        document.getElementById('hours').focus();
                        // Remove the event listener after use to prevent memory leaks
                        this.removeEventListener('shown.bs.modal', focusHours);
                    });
                    
                    timeModal.show();
                },
                
                showSuccessMessage(message) {
                    // Create a temporary flash message
                    const flashContainer = document.getElementById('flash-container') || this.createFlashContainer();
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    flashContainer.querySelector('.container-fluid').appendChild(alert);
                    flashContainer.style.display = 'block';
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                        alert.remove();
                        if (flashContainer.querySelectorAll('.alert').length === 0) {
                            flashContainer.style.display = 'none';
                        }
                    }, 3000);
                },
                
                showErrorMessage(message) {
                    // Create a temporary flash message
                    const flashContainer = document.getElementById('flash-container') || this.createFlashContainer();
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-danger alert-dismissible fade show';
                    alert.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    flashContainer.querySelector('.container-fluid').appendChild(alert);
                    flashContainer.style.display = 'block';
                },
                
                createFlashContainer() {
                    const container = document.createElement('div');
                    container.id = 'flash-container';
                    container.className = 'flash-messages-container';
                    container.innerHTML = '<div class="container-fluid"></div>';
                    document.querySelector('.main-content').prepend(container);
                    return container;
                }
            }
        }
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- HTMX (for future use) -->
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    
    <!-- Flash Messages Script -->
    <script>
        function checkEmptyContainer() {
            // Wait for Bootstrap's alert close animation to complete
            setTimeout(function() {
                const container = document.getElementById('flash-container');
                if (container && container.querySelectorAll('.alert').length === 0) {
                    container.style.display = 'none';
                }
            }, 200);
        }
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html> 