{% extends "base.html" %}

{% block title %}Projects - Hub Tracker{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">Projects</h2>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                    <i class="bi bi-plus-circle me-2"></i>Add Project
                </button>
            </div>
        </div>
    </div>

    <!-- Projects List -->
    <div class="row">
        <div class="col-12">
            {% if active_projects or archived_projects %}
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="border-0">Project</th>
                                        <th class="border-0">Client</th>
                                        <th class="border-0">Lead</th>
                                        <th class="border-0">Tasks</th>
                                        <th class="border-0">Status</th>
                                        <th class="border-0 text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for project in active_projects %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="fw-medium mb-0">
                                                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="text-decoration-none">
                                                            {{ project.name }}
                                                        </a>
                                                        {% if project.is_default %}
                                                        <span class="badge-clean badge-default">Default</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ project.client.name }}</td>
                                        <td>
                                            {% if project.project_leader %}
                                                {{ project.project_leader.full_name }}
                                            {% else %}
                                                <span class="text-muted">Not assigned</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge-clean badge-count">{{ project.open_tasks_count }}</span>
                                        </td>
                                        <td>
                                            {% if project.status == 'Active' %}
                                                <span class="badge-clean badge-status-active">{{ project.status }}</span>
                                            {% elif project.status == 'Prospective' %}
                                                <span class="badge-clean badge-status-prospective">{{ project.status }}</span>
                                            {% else %}
                                                <span class="badge-clean badge-status-archived">{{ project.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <div class="action-btn-group">
                                                <button type="button" class="action-btn-clean btn-edit" 
                                                        onclick="editProject({{ project.id }}, '{{ project.name }}', {{ project.client_id }}, {{ project.project_lead_id or 'null' }}, '{{ project.notes or '' }}', '{{ project.status }}', {{ project.is_default|lower }})"
                                                        data-bs-toggle="modal" data-bs-target="#editProjectModal"
                                                        title="Edit Project">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="action-btn-clean btn-delete" 
                                                        onclick="confirmProjectDelete('{{ project.name }}', '{{ url_for('delete_project', project_id=project.id) }}', {{ project.open_tasks_count }})"
                                                        title="Delete Project">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                    {% for project in archived_projects %}
                                    <tr class="table-secondary">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="fw-medium mb-0">
                                                        <a href="{{ url_for('project_detail', project_id=project.id) }}" class="text-decoration-none">
                                                            {{ project.name }}
                                                        </a>
                                                        {% if project.is_default %}
                                                        <span class="badge-clean badge-default">Default</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ project.client.name }}</td>
                                        <td>
                                            {% if project.project_leader %}
                                                {{ project.project_leader.full_name }}
                                            {% else %}
                                                <span class="text-muted">Not assigned</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge-clean badge-count">{{ project.open_tasks_count }}</span>
                                        </td>
                                        <td>
                                            <span class="badge-clean badge-status-archived">{{ project.status }}</span>
                                        </td>
                                        <td class="text-end">
                                            <div class="action-btn-group">
                                                <!-- Pin toggle -->
                                                <form method="POST" action="{{ url_for('unpin_project' if project.is_pinned else 'pin_project', project_id=project.id) }}" class="d-inline">
                                                    <button type="submit" class="action-btn-clean btn-view" title="{{ 'Unpin Project' if project.is_pinned else 'Pin Project' }}">
                                                        <i class="bi bi-pin-fill {{ 'text-warning' if project.is_pinned else 'text-muted' }}"></i>
                                                    </button>
                                                </form>
                                                <button type="button" class="action-btn-clean btn-edit" 
                                                        onclick="editProject({{ project.id }}, '{{ project.name }}', {{ project.client_id }}, {{ project.project_lead_id or 'null' }}, '{{ project.notes or '' }}', '{{ project.status }}', {{ project.is_default|lower }})"
                                                        data-bs-toggle="modal" data-bs-target="#editProjectModal"
                                                        title="Edit Project">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button type="button" class="action-btn-clean btn-delete" 
                                                        onclick="confirmProjectDelete('{{ project.name }}', '{{ url_for('delete_project', project_id=project.id) }}', {{ project.open_tasks_count }})"
                                                        title="Delete Project">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-folder fs-1 mb-3 d-block"></i>
                    <div class="fw-medium">No projects found</div>
                    <div class="small mb-3">Create your first project to get started</div>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">
                        <i class="bi bi-plus-circle me-2"></i>Add Project
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_project') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addProjectName" class="form-label">Project Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="addProjectName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="addProjectClient" class="form-label">Client <span class="text-danger">*</span></label>
                        <select class="form-select" id="addProjectClient" name="client_id" required>
                            <option value="">Select a client...</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                        {% if not clients %}
                            <div class="form-text text-warning">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                No clients available. <a href="{{ url_for('clients') }}">Create a client first</a>.
                            </div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label for="addProjectLead" class="form-label">Project Lead</label>
                        <select class="form-select" id="addProjectLead" name="project_lead_id">
                            <option value="">Select a project lead...</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addProjectStatus" class="form-label">Status</label>
                        <select class="form-select" id="addProjectStatus" name="status" required>
                            <option value="Active">Active</option>
                            <option value="Awaiting">Awaiting</option>
                            <option value="Paused">Paused</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="addProjectNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="addProjectNotes" name="notes" rows="3" placeholder="Optional project notes..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addProjectDefault" name="is_default">
                            <label class="form-check-label" for="addProjectDefault">
                                Set as default project
                            </label>
                            <div class="form-text">Tasks without a specified project will be assigned here</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Project</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div class="modal fade" id="editProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="editProjectForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editProjectName" class="form-label">Project Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editProjectName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectClient" class="form-label">Client <span class="text-danger">*</span></label>
                        <select class="form-select" id="editProjectClient" name="client_id" required>
                            <option value="">Select a client...</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectLead" class="form-label">Project Lead</label>
                        <select class="form-select" id="editProjectLead" name="project_lead_id">
                            <option value="">Select a project lead...</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectStatus" class="form-label">Status</label>
                        <select class="form-select" id="editProjectStatus" name="status" required>
                            <option value="Active">Active</option>
                            <option value="Awaiting">Awaiting</option>
                            <option value="Paused">Paused</option>
                            <option value="Archived">Archived</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editProjectNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editProjectNotes" name="notes" rows="3" placeholder="Optional project notes..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editProjectDefault" name="is_default">
                            <label class="form-check-label" for="editProjectDefault">
                                Set as default project
                            </label>
                            <div class="form-text">Tasks without a specified project will be assigned here</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Project</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteItemName"></span>"?</p>
                <div id="openTasksWarning" class="alert alert-warning" style="display: none;">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This project has <span id="openTasksCount"></span> open task(s). 
                    Deleting this project will also permanently delete all associated tasks.
                </div>
                <p class="text-muted mb-0">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete Project</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function editProject(id, name, clientId, projectLeadId, notes, status, isDefault) {
    document.getElementById('editProjectForm').action = `/edit_project/${id}`;
    document.getElementById('editProjectName').value = name;
    document.getElementById('editProjectClient').value = clientId;
    document.getElementById('editProjectLead').value = projectLeadId || '';
    document.getElementById('editProjectNotes').value = notes;
    document.getElementById('editProjectStatus').value = status;
    document.getElementById('editProjectDefault').checked = isDefault;
}

function confirmProjectDelete(itemName, deleteUrl, openTasksCount) {
    document.getElementById('deleteItemName').textContent = itemName;
    document.getElementById('deleteForm').action = deleteUrl;
    
    // Show warning if there are open tasks
    const warningDiv = document.getElementById('openTasksWarning');
    const taskCountSpan = document.getElementById('openTasksCount');
    
    if (openTasksCount > 0) {
        taskCountSpan.textContent = openTasksCount;
        warningDiv.style.display = 'block';
    } else {
        warningDiv.style.display = 'none';
    }
    
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %} 